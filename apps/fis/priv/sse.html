<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="chrome=1" />
    <title>Erlang Favicon Streamer</title>
    <script type="text/javascript" src="http://code.jquery.com/jquery-1.7.1.min.js"></script>
  </head>
  <body>

    <p>
      <button onclick="logger.clear()">Clear log</button>
      <button onclick="closeConnection()">Stop reconnections</button>

      <span id="connection">Connecting...<div></div></span>
    </p>
    <div class="border" id="log"></div>

    <script>
      // /events sends messages with text/event-stream mimetype.
      var source = new EventSource('/events');

      function closeConnection() {
        source.close();
        logger.log('> Connection was closed');
      }

      source.addEventListener('message', function(e) {
        if (e.origin != 'http://localhost:8000') {
          alert('Origin was not http://localhost:8000');
          return;
        }

        console.log(e.data);

        $("body").append('<img src="http://' + e.data + '" alt="favicon" /><br />');
      }, false);

      source.addEventListener('open', function(e) {
        console.log('> Connection was opened');
      }, false);

      source.addEventListener('error', function(e) {
        if (e.eventPhase == 2) { //EventSource.CLOSED
          console.log('> Connection was closed');
        }
      }, false);
    </script>
  </body>
</html>